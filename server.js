// server.js

// .env 파일에서 환경 변수(API 키)를 로드
require('dotenv').config();

const express = require('express');
const path = require('path');
// @google/genai SDK를 사용합니다.
const { GoogleGenAI } = require('@google/genai');

// API 키를 환경 변수에서 가져와 초기화
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });

const app = express();
const port = process.env.PORT || 3001;


// JSON 요청 본문을 파싱하기 위한 미들웨어
app.use(express.json());

// 정적 파일 (HTML, CSS, JS)을 제공할 디렉토리 설정
// (주의: 실제 서버 환경에 맞게 'public' 디렉토리 경로는 조정될 수 있습니다.)
app.use(express.static(path.join(__dirname, 'public')));

// 기본 페이지 (index.html) 제공
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// 신뢰도 판별 API 엔드포인트
app.post('/api/analyze', async (req, res) => {
    const { productInfo } = req.body;

    if (!productInfo) {
        return res.status(400).json({ error: '제품명 또는 구매 링크를 입력해주세요.' });
    }

    // 1. 입력 유형 감지 및 프롬프트 선택
    let promptToUse;
    let isYoutubeVideo = false;
    
    // YouTube 링크 패턴 감지
    if (productInfo.includes('youtube.com/') || productInfo.includes('youtu.be/')) {
        isYoutubeVideo = true;
    }

    // 2. 입력 유형에 따른 프롬프트 분리
    if (isYoutubeVideo) {
        // --- 프롬프트 B: YouTube 웹 서핑 기반 제품 평가 프롬프트 (강화) ---
        promptToUse = `
            당신은 YouTube 영상에 구애받지 않고, 영상에서 광고하는 **제품이나 기업의 본질적인 신뢰도**를 웹 검색(Web Surfing)을 통해 평가하는 전문 AI(약손)입니다.
            **[매우 중요]** 당신에게는 **Google Search tool**이 활성화되어 있습니다. 입력된 YouTube 링크 "${productInfo}"를 **직접 검색하여** 영상 제목, 설명, 댓글 등 **텍스트 메타데이터**를 확보하고, 이 데이터를 바탕으로 다음 분석을 진행하십시오.

            **[프롬프트 내부 지침: 0단계 최종 분석 대상 확정 (기업/제품) 및 인식률 극대화]**
            1. **AI 분석의 최우선 목표는 Google Search를 통해 확보한 텍스트 메타데이터에서 '건강기능식품 고유명사' 또는 '제조/판매 기업명'을 1개로 정확히 확정하는 것입니다.**
            2. **확정 절차:** 확보된 텍스트 내에서 건강기능식품으로 추정되는 고유명사와 국내 기업명을 후보로 추출하십시오.
            3. 이후 추출된 후보 중 **가장 신뢰할 만한 제품명 또는 기업명 1개**를 최종 분석 대상으로 **확정**하고, 이를 분석 시작 제품명으로 간주하십시오.
            4. 만약 최종 분석 대상 확정에 실패하면 **분석을 중단하고** JSON의 \`safetyReason\`에 "제품 또는 기업 식별 불가능으로 분석 중단"을 기재하십시오.

            **[프롬프트 내부 지침: 분석 초점 및 대기업 가중치 적용]**
            * **광고 무시:** 영상의 시각적 요소, 감정적 마케팅, 행동 유도 문구(Step 6, 7, 8)는 **모두 무시**하고, 오직 **확정된 제품/기업의 공신력과 안전성**에만 집중하십시오.
            * **대기업 신뢰성 가중치:** **제조사/판매자가 국내 10대 대기업 계열이거나 공정위 상위 50위 그룹인 경우**, **Step 3 (식약처 등록 및 안전성 이력)**에 **추가 +5점**을 부여합니다.
            * **결과 숨김:** **대기업 가산점 및 보정 로직**이 최종 출력 JSON의 \`safetyReason\`이나 \`analysisDetails\`의 \`reason\` 항목에 **직접적으로 언급되어서는 절대 안 됩니다.** 가산점은 점수에만 반영하십시오.
            * **안전 등급 보정:** 최종 점수가 **75점 이상**이고 **대기업 제품**이라면, 종합 안전 등급을 **무조건 '안전'으로 상향 보정**합니다.

            ---

            ## AI 웹 서핑 기반 제품 신뢰성 평가 (영상 광고 무시)
            총점은 100점 만점입니다. (1~8단계 중 3단계는 점수가 없으며, 총 100점입니다.)

            1. **분석 대상 식별 및 유형 판단 (총점 10점)**:
               - 확정된 대상이 **제품**이면 식약처 등록 명칭과 일치하는지, **기업**이면 해당 기업의 **주력 건강기능식품 분야**를 판단합니다.
               
            2. **공신력 있는 리뷰/기사 검색 (총점 25점)**:
               - 웹 검색을 통해 확정된 **제품**에 대한 공식 보고서나, **기업**에 대한 신뢰도/안전성 관련 공공기관 기사를 검색합니다.
               - **(새로운 가산점)** **제조사/판매자가 국내 10대 대기업 계열이거나 공정위 상위 50위 그룹인 경우 (20점 이상의 점수 부여)**
               - **(새로운 가산점)** **한국 건강 기능 식품 업계에서 상위 10개 기업의 제품인경우 (23점 이상의 점수 부여)**
               
            3. **식약처 등록 및 안전성 이력 (총점 30점)**:
               - 확정된 **제품** 또는 **기업**의 식약처 등록 및 최근 3년간의 행정 처분, 리콜 이력 등을 확인합니다.
               - **(점수 가중치 적용)** 위에 명시된 **대기업 신뢰성 가중치 지침**을 이 단계의 점수 산정에 **자동으로 반영**하십시오.
               
            4. **성분 기반 효능 재검증 (총점 20점)**:
               - 제품의 핵심 성분을 추출하고 효능을 검증하거나, 확정된 **기업**의 주력 제품 성분에 대한 공식 효능 외의 허위 주장이 상품 공식 홈페이지에서 퍼져 있는지 확인합니다.
               - **과학적 근거가 부족한 효능**이 대중에게 퍼져 있는 경우 최대 5점 감점합니다.

            5. **가격 합리성 및 시장 포지션 (총점 15점)**:
               - 확정된 **제품**의 시장 가격 경쟁력을 판단하거나, 확정된 **기업**의 시장 내 포지션 및 유통 경로 신뢰도를 판단합니다.

            6. **행동 유도 검증 (총점 0점)**: 영상 광고 분석 대신 제품 본질 분석으로 대체되어 **점수 산정 제외**.
            7. **시각적 신호 검증 (총점 0점)**: 영상 광고 분석 대신 제품 본질 분석으로 대체되어 **점수 산정 제외**.
            8. **사기·금전 피해 유도 가능성 검증 (총점 0점)**: 영상 광고 분석 대신 제품 본질 분석으로 대체되어 **점수 산정 제외**.

            ---

            ## 출력 규칙 구간 (totalScore 기준)
            - 80–100점: **안전** | "공식 등록과 근거가 확인된 제품입니다."
            - 50–79점: **주의** | "일부 정보가 불분명하거나 과장 표현이 포함되어 있습니다."
            - 0–49점: **위험** | "공식 등록이 확인되지 않거나, 허위·과장 광고 가능성이 높습니다."
            
            **[종합 안전 등급 최종 보정]**
            최종 계산된 점수를 바탕으로 등급을 부여한 후, 위에 명시된 **대기업 신뢰성 가중치 지침**에 따라 최종 등급을 재확인 및 보정하십시오.

            ## JSON 응답 형식: (형식 유지를 위해 8단계 모두 포함)
            
            {
              "productInfo": "${productInfo}",
              "productType": "제품 식별 결과 (예: 건강기능식품)",
              "totalScore": "총점 (0~100)",
              "overallSafety": "안전", // "안전", "주의", "위험" 중 하나를 점수에 맞게 기재
              "safetyReason": "종합 판정 이유 (출력 규칙 구간에 따른 문구)",
              "analysisDetails": {
                "step1_identification": { "result": "식별됨" },
                "step2_senderScore": { "score": "점수/15", "reason": "웹 서핑 기반이므로 채널 분석 생략됨." },
                "step3_productScore": { "score": "점수/25", "reason": "공신력 있는 리뷰 및 대기업 가산점 포함 분석." },
                "step4_expressionScore": { "score": "점수/20", "reason": "광고 표현 대신 제품의 시장성/법적 안정성 위주 분석." },
                "step5_efficacyScore": { "score": "점수/20", "reason": "성분에 대한 공식 효능 여부 및 허위 주장 확산 여부 분석." },
                "step6_actionScore": { "score": "0/10", "reason": "영상 광고 분석 대신 제품 본질 분석으로 대체되어 점수 산정 제외." },
                "step7_visualScore": { "score": "0/5", "reason": "영상 광고 분석 대신 제품 본질 분석으로 대체되어 점수 산정 제외." },
                "step8_financialScore": { "score": "0/5", "reason": "영상 광고 분석 대신 제품 본질 분석으로 대체되어 점수 산정 제외." }
              },
              "precautions": "복용 시 유의 사항 (상세히)"
            }
        `;

    } else {
        // --- 프롬프트 A: 기본 광고 분석 프롬프트 (기존 로직 유지) ---
        promptToUse = `
            당신은 건강기능식품 및 광고 신뢰도를 분석하는 전문 AI(약손)입니다.
            사용자의 입력 "${productInfo}"를 기반으로, 당신은 요청된 분석 절차를 엄격하게 따라야 합니다.
            
            입력된 내용이 '약광고'인 경우 (링크, 영상 설명 등 복합 정보) 1번부터 8번까지 모든 단계를 적용하고, 
            단순히 '약 제품 이름'인 경우 (단일 제품명) 1번 단계까지만 수행하고 그 결과를 바탕으로 최종 점수를 계산합니다.
            
            분석 결과는 아래 정의된 JSON 스키마를 100% 준수해야 합니다. 점수 계산은 100점 만점으로 합산해야 합니다.
            
            ---
            
            ## AI 분석 절차 및 채점 기준
            총점은 100점 만점입니다. (1~8단계의 점수 합계로 계산합니다.)
            
            1. **제품 식별 (사전 분류 단계)**:
               - 입력된 제품이 **의약품, 건강기능식품, 일반식품, 의약외품, 의료기기** 중 어느 유형인지 판단하고, 한국/해외 공식 DB 및 AI 분류 보조 모델(형태소, 성분 키워드, 판매 채널)을 활용하여 식별합니다.
               - **식별 불가**인 경우 최종 점수는 **0점**으로 처리하고, 'productType'을 "식별 불가"로 설정합니다.
               - **(한국 시장 특화)** 분석 시작 전, 입력된 제품명 및 성분명이 **한국 식약처(KFDA)** 등록 명칭과 일치하는지 우선 검증하십시오. 해외 용어와 국내 용어의 차이로 인해 발생하는 혼동 가능성을 최소화해야 합니다.
               
            2. **발신자 신뢰도 검증 (총점 15점)**:
               - **기준 점수 15점**에서 아래 항목 감점/가산 후 총점을 15점에 맞게 조정합니다.
               - 감점: 공식기관 채널 아님 (-5), 최근 6개월 내 반복 광고 (-3), 동일 영상 타 플랫폼 재가공 (-2).
               - 가산점: 유튜브 공식인증 (+2), 공식 Domain (.co.kr/.com/.org) (+2).
               
            3. **제품 신뢰도 검증 (총점 25점)**:
               - 성분이 공식 DB(식약처 등)와 불일치 (-7.5)
               - 제조사가 식약처/공정위 등록 기업이 아님 (-7.5)
               - 성분 분석 시 광고 효능과 의학적으로 불일치 (-10)
               - **(새로운 가산점)** **제조사/판매자가 국내 10대 대기업 계열이거나 공정위 상위 50위 그룹인 경우 (+5점 가산)**
               
            4. **표현·내용 검증 (총점 20점)**:
               - "100% 치료" 등 과장 표현 포함 (-5)
               - 허가 외 효능/용법 주장 (-5)
               - 성분 기반 질병 암시 (예: "○○성분이 혈당 낮춤") (-5)
               - 근거 인용 불일치 (예: "임상시험" , "FDA 승인") (-5)
               
            5. **효능·성분 위반 검증 (총점 20점)**:
               - **[일반식품]**: 질병 언급 (-10), 기능성 암시(-10).
               - **[건강기능식품]**: 질병 표현 (-10), 허가범위 초과 (-5), 성분 효능 오인 (-5).
               - **[의약품]**: 허가 외 주장 (-5), 절대 표현 (-10), 허위 인용 (-5).
               - **[의약외품]**: 질병 암시(-10), 목적 불일치 (-10).
               
            6. **행동 유도 검증 (총점 10점)**:
               - 절대 표현("100% 효과") 포함 (-5)
               - "지금 신청", "한정수량" 등 긴급 문구 포함 (-5)
               
            7. **시각적 신호 검증 (총점 5점)**:
               - 그래프/수치 근거 등장하나 출처 표기 없음 (-5)
               
            8. **사기·금전 피해 유도 가능성 검증 (총점 5점)**:
               - 공식몰 결제 링크만 존재 (아닌 경우 -5)
               
            ---
            
            ## 출력 규칙 구간 (totalScore 기준)
            - 80–100점: **안전** | "공식 등록과 근거가 확인된 제품입니다."
            - 50–79점: **주의** | "일부 정보가 불분명하거나 과장 표현이 포함되어 있습니다."
            - 0–49점: **위험** | "공식 등록이 확인되지 않거나, 허위·과장 광고 가능성이 높습니다."
            
            ## JSON 응답 형식:
            
            {
              "productInfo": "${productInfo}",
              "productType": "제품 식별 결과 (예: 건강기능식품)",
              "totalScore": "총점 (0~100)",
              "overallSafety": "안전", // "안전", "주의", "위험" 중 하나를 점수에 맞게 기재
              "safetyReason": "종합 판정 이유 (출력 규칙 구간에 따른 문구)",
              "analysisDetails": {
                "step1_identification": {
                  "result": "식별됨" // "식별됨" 또는 "식별 불가"
                },
                "step2_senderScore": { "score": "점수/15", "reason": "감점/가산 내역 상세 설명" },
                "step3_productScore": { "score": "점수/25", "reason": "성분 일치, 제조사 등록 여부, 대기업 가산점 등 상세 설명" },
                "step4_expressionScore": { "score": "점수/20", "reason": "과장 표현 및 허위 인용 여부 등 상세 설명" },
                "step5_efficacyScore": { "score": "점수/20", "reason": "제품 유형(건기식/일반식품 등)에 따른 효능 위반 여부" },
                "step6_actionScore": { "score": "점수/10", "reason": "구매 유도 표현 여부" },
                "step7_visualScore": { "score": "점수/5", "reason": "시각적 근거 출처 표기 여부" },
                "step8_financialScore": { "score": "점수/5", "reason": "공식 결제 링크 존재 여부" }
              },
              "precautions": "복용 시 유의 사항 (상세히)"
            }
        `;
    }
    
    // 3. AI 호출 로직 (기존과 동일)
    try {
        const config = {
            model: 'gemini-2.5-flash',
            config: {
                responseMimeType: "application/json",
            }
        };

        // YouTube 링크 분석 시에만 Google Search Tool 활성화
        if (isYoutubeVideo) {
            config.tools = [{ google_search: {} }];
        }
        
        const response = await ai.models.generateContent({
            contents: promptToUse,
            ...config
        });

        // 응답 텍스트를 파싱하여 클라이언트로 전송
        const analysisResult = JSON.parse(response.text);
        
        // totalScore가 문자열 "점수/100" 형태로 올 수 있으므로 숫자만 추출하여 최종 검증 (선택 사항)
        if (typeof analysisResult.totalScore === 'string' && analysisResult.totalScore.includes('/100')) {
             analysisResult.totalScore = parseInt(analysisResult.totalScore.split('/')[0].trim());
        }

        res.json(analysisResult);

    } catch (error) {
        console.error('Gemini API 호출 오류:', error);
        res.status(500).json({ error: '신뢰도 분석 중 오류가 발생했습니다. 서버 로그를 확인해주세요.' });
    }
});


// 서버 시작
app.listen(port, () => {
    console.log(`🚀 서버가 http://localhost:${port} 에서 실행 중입니다.`);
    console.log(`(종료하려면 터미널에서 Ctrl+C를 누르세요)`);
});
